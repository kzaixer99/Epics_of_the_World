<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terra • Epic Chronicles</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=IM+Fell+English:ital@0;1&display=swap');
        
        :root {
            --parchment: #f4e8d0;
            --aged-paper: #e8dcc4;
            --ink-black: #2a1810;
            --sepia-brown: #6b4423;
            --vermillion: #c1440e;
            --gold-leaf: #d4af37;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Crimson Pro', serif;
            background: linear-gradient(135deg, var(--aged-paper) 0%, var(--parchment) 100%);
            color: var(--ink-black);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(107, 68, 35, 0.03) 2px, rgba(107, 68, 35, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(107, 68, 35, 0.03) 2px, rgba(107, 68, 35, 0.03) 4px);
            opacity: 0.4;
            pointer-events: none;
            z-index: 0;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(193, 68, 14, 0.08) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 70%, rgba(107, 68, 35, 0.08) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 1s ease-out;
        }
        
        h1 {
            font-family: 'Cinzel', serif;
            font-size: clamp(2.5rem, 5vw, 4.5rem);
            font-weight: 900;
            color: var(--ink-black);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            text-shadow: 2px 2px 0 rgba(212, 175, 55, 0.3);
            margin-bottom: 0.5rem;
            position: relative;
            display: inline-block;
        }
        
        h1::first-letter {
            font-size: 1.4em;
            color: var(--vermillion);
            text-shadow: 3px 3px 0 rgba(212, 175, 55, 0.4);
        }
        
        h1::after {
            content: '⚜';
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gold-leaf);
            font-size: 0.5em;
            opacity: 0.6;
        }
        
        .subtitle {
            font-family: 'IM Fell English', serif;
            font-size: clamp(1rem, 2vw, 1.2rem);
            font-style: italic;
            color: var(--sepia-brown);
            letter-spacing: 0.15em;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            align-items: start;
        }
        
        @media (min-width: 1024px) {
            .main-content {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        .globe-container {
            background: rgba(244, 232, 208, 0.6);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid var(--sepia-brown);
            box-shadow: 
                0 0 0 1px var(--gold-leaf),
                0 20px 60px rgba(42, 24, 16, 0.3);
            animation: fadeIn 1s ease-out 0.3s backwards;
        }
        
        #canvas-container {
            width: 100%;
            height: 500px;
            position: relative;
            cursor: grab;
            border-radius: 10px;
        }
        
        #canvas-container:active {
            cursor: grabbing;
        }
        
        .controls {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-btn {
            background: rgba(244, 232, 208, 0.9);
            border: 2px solid var(--sepia-brown);
            color: var(--ink-black);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(42, 24, 16, 0.2);
        }
        
        .control-btn:hover {
            background: var(--vermillion);
            color: var(--parchment);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(193, 68, 14, 0.4);
        }
        
        .info-text {
            text-align: center;
            margin-top: 1rem;
            color: var(--sepia-brown);
            font-family: 'IM Fell English', serif;
            font-size: 0.9rem;
            font-style: italic;
        }
        
        .locations-panel {
            background: rgba(244, 232, 208, 0.6);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid var(--sepia-brown);
            box-shadow: 
                0 0 0 1px var(--gold-leaf),
                0 20px 60px rgba(42, 24, 16, 0.3);
            animation: fadeIn 1s ease-out 0.5s backwards;
            max-height: 700px;
            overflow-y: auto;
        }
        
        .panel-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--ink-black);
            font-weight: 900;
            text-transform: uppercase;
            border-bottom: 3px solid var(--vermillion);
            padding-bottom: 0.5rem;
        }
        
        .location-item {
            padding: 1rem;
            margin-bottom: 1rem;
            background: rgba(232, 220, 196, 0.5);
            border-radius: 12px;
            border-left: 3px solid var(--gold-leaf);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .location-item:hover {
            background: rgba(193, 68, 14, 0.15);
            transform: translateX(5px);
        }
        
        .location-name {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--ink-black);
        }
        
        .location-coords {
            font-family: 'IM Fell English', serif;
            font-size: 0.85rem;
            color: var(--sepia-brown);
            font-style: italic;
            margin-top: 0.3rem;
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(42, 24, 16, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .popup-overlay.active {
            display: flex;
            animation: fadeInPopup 0.4s ease forwards;
        }
        
        .popup {
            background: linear-gradient(135deg, #f8f2e4 0%, #f4e8d0 100%);
            border: 3px solid var(--sepia-brown);
            border-radius: 8px;
            padding: 2.5rem 1.5rem 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 
                0 0 0 1px var(--gold-leaf),
                0 20px 60px rgba(42, 24, 16, 0.6);
            animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        .popup::before,
        .popup::after {
            content: '❦';
            position: absolute;
            font-size: 2rem;
            color: var(--vermillion);
            opacity: 0.3;
        }
        
        .popup::before {
            top: 10px;
            left: 10px;
        }
        
        .popup::after {
            bottom: 10px;
            right: 10px;
            transform: rotate(180deg);
        }
        
        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--parchment);
            border: 2px solid var(--sepia-brown);
            color: var(--sepia-brown);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            z-index: 10;
        }
        
        .close-btn:hover {
            background: var(--vermillion);
            color: var(--parchment);
            transform: rotate(90deg);
        }
        
        .popup h2 {
            font-family: 'Cinzel', serif;
            font-size: clamp(1.3rem, 4vw, 2.2rem);
            font-weight: 900;
            color: var(--ink-black);
            text-transform: uppercase;
            padding-bottom: 1rem;
            padding-right: 2rem;
        }
        
        .popup h2::first-letter {
            font-size: 1.6em;
            color: var(--vermillion);
            float: left;
            margin-right: 0.1em;
        }
        
        .epic-meta {
            margin: 1.5rem 0;
            padding: 1.25rem;
            background: rgba(232, 220, 196, 0.4);
            border-left: 3px solid var(--gold-leaf);
        }
        
        .meta-item {
            margin-bottom: 1rem;
        }
        
        .meta-label {
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--sepia-brown);
            font-weight: 600;
            margin-bottom: 0.3rem;
        }
        
        .meta-value {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            color: var(--ink-black);
        }
        
        .summary {
            line-height: 1.9;
            color: var(--ink-black);
            margin: 1.5rem 0;
            text-align: justify;
            text-indent: 2em;
        }
        
        .quote-section {
            margin: 2rem 0;
            padding: 1.25rem;
            background: rgba(212, 175, 55, 0.08);
            border-left: 4px solid var(--gold-leaf);
            position: relative;
        }
        
        .quote-section::before {
            content: '"';
            position: absolute;
            top: -10px;
            left: 10px;
            font-size: 3rem;
            font-family: 'Cinzel', serif;
            color: var(--gold-leaf);
            opacity: 0.3;
        }
        
        .quote-text {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            color: var(--ink-black);
            line-height: 1.8;
        }
        
        .coordinates {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid rgba(107, 68, 35, 0.2);
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            color: var(--sepia-brown);
            text-align: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInPopup {
            to { opacity: 1; }
        }
        
        @keyframes popIn {
            to { transform: scale(1); }
        }
        
        @media (max-width: 768px) {
            #canvas-container { height: 400px; }
            .container { padding: 1rem; }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .locations-panel {
                max-height: 400px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            h1::after {
                right: -20px;
                font-size: 0.4em;
            }
            
            .subtitle {
                font-size: 0.9rem;
            }
            
            .popup {
                padding: 2rem 1rem 1.5rem;
                max-height: 80vh;
            }
            
            .popup h2 {
                font-size: 1.5rem;
                padding-right: 3rem;
            }
            
            .epic-meta {
                padding: 1rem;
                font-size: 0.9rem;
            }
            
            .control-btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.85rem;
            }
        }
        
        @media (max-width: 480px) {
            .container { padding: 0.5rem; }
            
            #canvas-container { 
                height: 350px;
                border-radius: 5px;
            }
            
            .globe-container {
                padding: 1rem;
                border-radius: 15px;
            }
            
            .locations-panel {
                padding: 1rem;
                border-radius: 15px;
                max-height: 300px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .panel-title {
                font-size: 1.3rem;
            }
            
            .location-item {
                padding: 0.8rem;
            }
            
            .location-name {
                font-size: 1rem;
            }
            
            .location-coords {
                font-size: 0.75rem;
            }
            
            .controls {
                gap: 0.5rem;
            }
            
            .control-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Terra</h1>
            <p class="subtitle">A Cartography of Timeless Tales</p>
        </header>
        
        <div class="main-content">
            <div class="globe-container">
                <div id="canvas-container"></div>
                <div class="controls">
                    <button class="control-btn" id="rotateBtn">Toggle Rotation</button>
                    <button class="control-btn" id="resetBtn">Reset View</button>
                    <button class="control-btn" id="markersBtn">Toggle Markers</button>
                </div>
                <p class="info-text">Drag to rotate • Scroll to zoom • Click markers to explore</p>
            </div>
            
            <div class="locations-panel">
                <h2 class="panel-title">Epic Chronicles</h2>
                <div id="locations-list"></div>
            </div>
        </div>
    </div>
    
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup">
            <button class="close-btn" id="closeBtn">×</button>
            <h2 id="popupTitle"></h2>
            <div class="epic-meta" id="epicMeta"></div>
            <p class="summary" id="popupSummary"></p>
            <div class="quote-section">
                <div class="quote-text" id="popupQuote"></div>
            </div>
            <div class="coordinates" id="popupCoords"></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const locations = [
            {
                name: 'Mahabharata',
                characters: 'Krishna, Arjuna, Yudhishthira, Karna',
                place: 'Kurukshetra, Northern India',
                timePeriod: 'Set ~1500–1000 BCE, Composed ~400 BCE – 400 CE',
                summary: 'A colossal epic of dynastic war and moral dilemmas, centered on dharma, destiny, and human choice.',
                quote: 'You have the right to perform your duty, but not to the fruits of your actions.',
                lat: 29.9697,
                lon: 76.8345,
                desc: 'Ancient India'
            },
            {
                name: 'Odyssey',
                characters: 'Odysseus, Penelope, Telemachus',
                place: 'Mediterranean, Ithaca',
                timePeriod: 'Set ~12th century BCE, Composed ~8th century BCE',
                summary: 'Odysseus\' long return home, shaped by wit, endurance, and divine intervention.',
                quote: 'There is nothing more admirable than when two people who see eye to eye keep house as man and wife.',
                lat: 38.4350,
                lon: 20.6117,
                desc: 'Ancient Greece'
            },
            {
                name: 'Ragnarök',
                characters: 'Odin, Thor, Loki',
                place: 'Norse Cosmos',
                timePeriod: 'Mythic future, Recorded ~13th century CE',
                summary: 'The foretold apocalypse of Norse mythology, ending in destruction and rebirth.',
                quote: 'Brothers will fight and kill each other, and the bonds of kinship will be sundered.',
                lat: 60.1282,
                lon: 18.6435,
                desc: 'Norse Mythology'
            },
            {
                name: 'Journey to the West',
                characters: 'Sun Wukong, Xuanzang',
                place: 'China → India',
                timePeriod: 'Set 7th century CE, Written 16th century CE',
                summary: 'A spiritual and comic pilgrimage blending Buddhism, folklore, and fantasy.',
                quote: 'Even a journey of a thousand miles begins with a single step.',
                lat: 34.2667,
                lon: 108.9000,
                desc: 'Ancient China'
            },
            {
                name: 'Arabian Nights',
                characters: 'Scheherazade, Shahryar',
                place: 'Middle East, South Asia',
                timePeriod: 'Set 8th–14th century CE, Compiled 9th–15th century CE',
                summary: 'Interlinked tales of survival, imagination, and human cunning framed by Scheherazade\'s storytelling.',
                quote: 'Trust in Allah, but tie your camel.',
                lat: 33.3152,
                lon: 44.3661,
                desc: 'Ancient Mesopotamia'
            },
            {
                name: 'Epic of Gilgamesh',
                characters: 'Gilgamesh, Enkidu',
                place: 'Uruk, Mesopotamia',
                timePeriod: 'Set ~2700 BCE, Written ~2100–1200 BCE',
                summary: 'A profound exploration of friendship, power, and the inevitability of death.',
                quote: 'What you seek you shall never find. For when the Gods created man, they let death be his lot.',
                lat: 31.3247,
                lon: 45.6364,
                desc: 'Ancient Mesopotamia'
            },
            {
                name: 'Canterbury Tales',
                characters: 'Wife of Bath, The Knight, The Pardoner',
                place: 'England',
                timePeriod: 'Set 14th century CE, Written ~1387–1400 CE',
                summary: 'A lively cross-section of medieval society revealed through storytelling pilgrims.',
                quote: 'The lyf so short, the craft so long to lerne.',
                lat: 51.2802,
                lon: 1.0789,
                desc: 'Medieval England'
            },
            {
                name: 'Iliad',
                characters: 'Achilles, Hector, Agamemnon',
                place: 'Troy',
                timePeriod: 'Set ~12th century BCE, Composed ~8th century BCE',
                summary: 'A war epic centered on honor, rage, and the tragic cost of glory.',
                quote: 'Sing, O goddess, the anger of Achilles son of Peleus, that brought countless ills upon the Achaeans.',
                lat: 39.9577,
                lon: 26.2389,
                desc: 'Ancient Troy'
            },
            {
                name: 'Ramayana',
                characters: 'Rama, Sita, Hanuman, Ravana',
                place: 'Ayodhya, Lanka',
                timePeriod: 'Set Treta Yuga, Written ~500 BCE – 100 CE',
                summary: 'The idealized journey of righteousness, devotion, and kingship.',
                quote: 'Even if I have to give up my life, I will not abandon dharma.',
                lat: 26.7922,
                lon: 82.1998,
                desc: 'Ancient India'
            },
            {
                name: 'The Divine Comedy',
                characters: 'Dante, Virgil, Beatrice',
                place: 'Hell, Purgatory, Heaven',
                timePeriod: 'Set 1300 CE, Written 1308–1321 CE',
                summary: 'An allegorical journey of the soul toward divine truth.',
                quote: 'Abandon all hope, ye who enter here.',
                lat: 43.7696,
                lon: 11.2558,
                desc: 'Medieval Italy'
            },
            {
                name: 'Paradise Lost',
                characters: 'Adam, Eve, Satan, Jesus',
                place: 'Heaven, Hell, Eden',
                timePeriod: 'Biblical prehistory, Written 1667 CE',
                summary: 'The fall and redemption of humanity through free will and divine grace.',
                quote: 'Better to reign in Hell than serve in Heaven.',
                lat: 51.5074,
                lon: -0.1278,
                desc: 'England'
            },
            {
                name: 'Meghnad Vadh Kavya',
                characters: 'Meghnad, Ravana, Lakshmana',
                place: 'Lanka',
                timePeriod: 'Set Treta Yuga, Written 1861 CE',
                summary: 'A tragic, heroic retelling of the Ramayana from the antagonist\'s perspective.',
                quote: 'Victory and defeat are both fleeting; only honor endures through time.',
                lat: 7.8731,
                lon: 80.7718,
                desc: 'Ancient Lanka'
            }
        ];
        
        let scene, camera, renderer, globe, markers = [];
        let autoRotate = true, showMarkers = true, isDragging = false;
        let previousMouse = { x: 0, y: 0 };
        let lastTouchDistance = 0;
        
        function init() {
            const container = document.getElementById('canvas-container');
            
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 3;
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            
            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambient);
            const light = new THREE.DirectionalLight(0xffffff, 1.0);
            light.position.set(5, 3, 5);
            scene.add(light);
            
            createGlobe();
            createMarkers();
            setupEvents();
            populateList();
            animate();
        }
        
        function createGlobe() {
            globe = new THREE.Group();
            const geo = new THREE.SphereGeometry(1, 64, 64);
            const loader = new THREE.TextureLoader();
            
            const mat = new THREE.MeshPhongMaterial({
                map: loader.load('https://unpkg.com/three-globe@2.31.0/example/img/earth-blue-marble.jpg'),
                bumpMap: loader.load('https://unpkg.com/three-globe@2.31.0/example/img/earth-topology.png'),
                bumpScale: 0.005,
                shininess: 25
            });
            
            const earth = new THREE.Mesh(geo, mat);
            globe.add(earth);
            
            const cloudGeo = new THREE.SphereGeometry(1.01, 64, 64);
            const cloudMat = new THREE.MeshPhongMaterial({
                map: loader.load('https://unpkg.com/three-globe@2.31.0/example/img/earth-clouds.png'),
                transparent: true,
                opacity: 0.3
            });
            const clouds = new THREE.Mesh(cloudGeo, cloudMat);
            globe.add(clouds);
            globe.userData.clouds = clouds;
            
            const atmGeo = new THREE.SphereGeometry(1.08, 64, 64);
            const atmMat = new THREE.ShaderMaterial({
                transparent: true,
                side: THREE.BackSide,
                uniforms: { c: { value: 0.4 }, p: { value: 6.5 } },
                vertexShader: `varying vec3 vNormal; void main() { vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
                fragmentShader: `uniform float c; uniform float p; varying vec3 vNormal; void main() { float intensity = pow(c - dot(vNormal, vec3(0, 0, 1)), p); gl_FragColor = vec4(0.85, 0.75, 0.6, 1.0) * intensity; }`
            });
            globe.add(new THREE.Mesh(atmGeo, atmMat));
            scene.add(globe);
        }
        
        function createMarkers() {
            locations.forEach(loc => {
                const group = new THREE.Group();
                const phi = (90 - loc.lat) * Math.PI / 180;
                const theta = (loc.lon + 180) * Math.PI / 180;
                const r = 1.02;
                const x = -(r * Math.sin(phi) * Math.cos(theta));
                const y = r * Math.cos(phi);
                const z = r * Math.sin(phi) * Math.sin(theta);
                
                const pin = new THREE.Mesh(
                    new THREE.ConeGeometry(0.02, 0.08, 8),
                    new THREE.MeshPhongMaterial({ color: 0xd4af37, emissive: 0xc1440e, shininess: 100 })
                );
                pin.position.set(x, y, z);
                pin.lookAt(0, 0, 0);
                pin.rotateX(Math.PI);
                
                const glow = new THREE.Mesh(
                    new THREE.SphereGeometry(0.03, 16, 16),
                    new THREE.MeshBasicMaterial({ color: 0xd4af37, transparent: true, opacity: 0.6 })
                );
                glow.position.set(x, y, z);
                
                group.add(pin);
                group.add(glow);
                group.userData = loc;
                group.userData.phase = Math.random() * Math.PI * 2;
                markers.push(group);
                globe.add(group);
            });
        }
        
        function animate() {
            requestAnimationFrame(animate);
            if (autoRotate && !isDragging) globe.rotation.y += 0.001;
            if (globe.userData.clouds) globe.userData.clouds.rotation.y += 0.0002;
            
            markers.forEach(m => {
                m.userData.phase += 0.05;
                const g = m.children[1];
                if (g && showMarkers) {
                    g.material.opacity = 0.4 + Math.sin(m.userData.phase) * 0.3;
                    g.scale.setScalar(1 + Math.sin(m.userData.phase) * 0.2);
                }
                m.visible = showMarkers;
            });
            
            renderer.render(scene, camera);
        }
        
        function setupEvents() {
            const canvas = renderer.domElement;
            let clickStartPos = { x: 0, y: 0 };
            let hasDragged = false;
            let lastTouchDistance = 0;
            
            // Helper to get position from mouse or touch event
            function getInputPosition(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }
            
            // Mouse events
            canvas.addEventListener('mousedown', e => { 
                isDragging = true; 
                hasDragged = false;
                clickStartPos = { x: e.clientX, y: e.clientY };
                previousMouse = { x: e.clientX, y: e.clientY }; 
            });
            
            canvas.addEventListener('mousemove', e => {
                if (!isDragging) {
                    // Hover effect (desktop only)
                    const ray = new THREE.Raycaster();
                    const mouse = new THREE.Vector2();
                    const rect = canvas.getBoundingClientRect();
                    mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                    ray.setFromCamera(mouse, camera);
                    
                    const hits = ray.intersectObjects(markers, true);
                    if (hits.length > 0) {
                        canvas.style.cursor = 'pointer';
                    } else {
                        canvas.style.cursor = 'grab';
                    }
                    return;
                }
                
                const dx = e.clientX - previousMouse.x;
                const dy = e.clientY - previousMouse.y;
                
                if (Math.abs(dx) > 2 || Math.abs(dy) > 2) {
                    hasDragged = true;
                }
                
                globe.rotation.y += dx * 0.005;
                globe.rotation.x += dy * 0.005;
                globe.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, globe.rotation.x));
                previousMouse = { x: e.clientX, y: e.clientY };
                canvas.style.cursor = 'grabbing';
            });
            
            canvas.addEventListener('mouseup', (e) => {
                isDragging = false;
                canvas.style.cursor = 'grab';
                
                // Only trigger click if we haven't dragged
                if (!hasDragged) {
                    const ray = new THREE.Raycaster();
                    const mouse = new THREE.Vector2();
                    const rect = canvas.getBoundingClientRect();
                    mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                    ray.setFromCamera(mouse, camera);
                    
                    const hits = ray.intersectObjects(markers, true);
                    if (hits.length > 0) {
                        let obj = hits[0].object;
                        // Find the parent group that has the userData
                        while (obj.parent && obj.parent.type === 'Group' && obj.parent.userData.name) {
                            obj = obj.parent;
                        }
                        if (obj.userData && obj.userData.name) {
                            showPopup(obj.userData);
                        }
                    }
                }
            });
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches.length === 1) {
                    isDragging = true;
                    hasDragged = false;
                    const pos = getInputPosition(e);
                    clickStartPos = { x: pos.x, y: pos.y };
                    previousMouse = { x: pos.x, y: pos.y };
                }
            }, { passive: false });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                // Pinch to zoom
                if (e.touches.length === 2) {
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const distance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    
                    if (lastTouchDistance > 0) {
                        const delta = lastTouchDistance - distance;
                        camera.position.z += delta * 0.01;
                        camera.position.z = Math.max(1.5, Math.min(5, camera.position.z));
                    }
                    lastTouchDistance = distance;
                    return;
                }
                
                // Single touch drag
                if (isDragging && e.touches.length === 1) {
                    const pos = getInputPosition(e);
                    const dx = pos.x - previousMouse.x;
                    const dy = pos.y - previousMouse.y;
                    
                    if (Math.abs(dx) > 2 || Math.abs(dy) > 2) {
                        hasDragged = true;
                    }
                    
                    globe.rotation.y += dx * 0.005;
                    globe.rotation.x += dy * 0.005;
                    globe.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, globe.rotation.x));
                    previousMouse = { x: pos.x, y: pos.y };
                }
            }, { passive: false });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                
                if (e.touches.length === 0) {
                    lastTouchDistance = 0;
                    
                    // Check for tap (not drag)
                    if (!hasDragged && e.changedTouches.length > 0) {
                        const touch = e.changedTouches[0];
                        const ray = new THREE.Raycaster();
                        const mouse = new THREE.Vector2();
                        const rect = canvas.getBoundingClientRect();
                        mouse.x = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
                        mouse.y = -((touch.clientY - rect.top) / rect.height) * 2 + 1;
                        ray.setFromCamera(mouse, camera);
                        
                        const hits = ray.intersectObjects(markers, true);
                        if (hits.length > 0) {
                            let obj = hits[0].object;
                            while (obj.parent && obj.parent.type === 'Group' && obj.parent.userData.name) {
                                obj = obj.parent;
                            }
                            if (obj.userData && obj.userData.name) {
                                showPopup(obj.userData);
                            }
                        }
                    }
                    
                    isDragging = false;
                }
            }, { passive: false });
            
            // Mouse wheel zoom
            canvas.addEventListener('wheel', e => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.001;
                camera.position.z = Math.max(1.5, Math.min(5, camera.position.z));
            }, { passive: false });
            
            document.getElementById('rotateBtn').onclick = () => autoRotate = !autoRotate;
            document.getElementById('resetBtn').onclick = () => { globe.rotation.x = 0; globe.rotation.y = 0; camera.position.z = 3; };
            document.getElementById('markersBtn').onclick = () => showMarkers = !showMarkers;
            document.getElementById('closeBtn').onclick = closePopup;
            document.getElementById('popupOverlay').onclick = e => { if (e.target.id === 'popupOverlay') closePopup(); };
            window.addEventListener('resize', () => {
                const c = document.getElementById('canvas-container');
                camera.aspect = c.clientWidth / c.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(c.clientWidth, c.clientHeight);
            });
        }
        
        function populateList() {
            const list = document.getElementById('locations-list');
            locations.forEach(loc => {
                const item = document.createElement('div');
                item.className = 'location-item';
                item.innerHTML = `<div class="location-name">${loc.name}</div><div class="location-coords">${loc.desc} • ${loc.lat.toFixed(2)}°, ${loc.lon.toFixed(2)}°</div>`;
                item.onclick = () => {
                    // Disable auto-rotation while animating
                    const wasRotating = autoRotate;
                    autoRotate = false;
                    
                    // Convert lat/lon to proper rotation
                    // Longitude: -180 to 180 degrees, controls Y rotation
                    // Latitude: -90 to 90 degrees, controls X rotation
                    const targetRotationY = -loc.lon * (Math.PI / 180);
                    const targetRotationX = loc.lat * (Math.PI / 180);
                    
                    // Normalize the target rotation to the shortest path
                    let deltaY = targetRotationY - globe.rotation.y;
                    while (deltaY > Math.PI) deltaY -= 2 * Math.PI;
                    while (deltaY < -Math.PI) deltaY += 2 * Math.PI;
                    
                    // Smooth rotation animation
                    const startRotationY = globe.rotation.y;
                    const startRotationX = globe.rotation.x;
                    const finalRotationY = startRotationY + deltaY;
                    const duration = 1500; // ms
                    const startTime = Date.now();
                    
                    function animateRotation() {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        // Easing function (ease-in-out)
                        const eased = progress < 0.5 
                            ? 2 * progress * progress 
                            : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                        
                        globe.rotation.y = startRotationY + (finalRotationY - startRotationY) * eased;
                        globe.rotation.x = startRotationX + (targetRotationX - startRotationX) * eased;
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateRotation);
                        } else {
                            // Animation complete, restore auto-rotation if it was on
                            autoRotate = wasRotating;
                            // Show popup after rotation completes
                            setTimeout(() => showPopup(loc), 200);
                        }
                    }
                    
                    animateRotation();
                };
                list.appendChild(item);
            });
        }
        
        function showPopup(loc) {
            document.getElementById('popupTitle').textContent = loc.name;
            document.getElementById('epicMeta').innerHTML = 
                `<div class="meta-item"><div class="meta-label">Characters</div><div class="meta-value">${loc.characters}</div></div>
                 <div class="meta-item"><div class="meta-label">Setting</div><div class="meta-value">${loc.place}</div></div>
                 <div class="meta-item"><div class="meta-label">Time Period</div><div class="meta-value">${loc.timePeriod}</div></div>`;
            document.getElementById('popupSummary').textContent = loc.summary || '';
            document.getElementById('popupQuote').textContent = loc.quote || '';
            document.getElementById('popupCoords').textContent = `Coordinates: ${loc.lat.toFixed(4)}°, ${loc.lon.toFixed(4)}°`;
            document.getElementById('popupOverlay').classList.add('active');
        }
        
        function closePopup() {
            document.getElementById('popupOverlay').classList.remove('active');
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
